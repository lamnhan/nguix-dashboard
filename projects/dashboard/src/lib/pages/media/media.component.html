<div class="host dashboard page" *ngIf="page$ | async as page; else loading">
  <div class="main" *ngIf="page.ok; else notFound">
  <ng-container *ngIf="data$ | async; let data">
  <ng-container
    *ngIf="data.listingItems | mediaQueryFilter : query; let filteredItems"
  >

    <div class="head">

      <div class="title">
        <h1>Media</h1>
        <button
          class="button-outline-primary"
          (click)="showUploader=true"
        >Add New</button>
      </div>

      <ul class="types" *ngIf="filteredItems | mediaExtractTypes as listingTypes">
        <ng-container *ngFor="let listingType of listingTypes">
          <li *ngIf="listingType.count">
            <strong *ngIf="listingType.value === type; else inactive">{{ listingType.title }}</strong>
            <ng-template #inactive>
              <a href="#" (click)="type=listingType.value; false">{{ listingType.title }}</a>
            </ng-template>
            <em>({{ listingType.count }})</em>
          </li>
        </ng-container>
      </ul>

    </div>

    <div class="body">
      
      <ng-template #listingBar>
        <div class="filter">
          <input
            class="form-control"
            type="search"
            placeholder="Filter items ..."
            [(ngModel)]="query"
          > 
        </div>
        <div class="counter">{{ counting.total }} items</div>
      </ng-template>

      <div class="headbar">
        <ng-container *ngTemplateOutlet="listingBar"></ng-container>
      </div>

      <div class="major">

        <table class="listing table-striped">

          <thead>
            <tr>
              <th class="name">Name</th>
              <th class="size">Size</th>
              <th class="type">Type</th>
              <th class="date">Date</th>
            </tr>
          </thead>

          <tbody>
            <tr
              *ngFor="
                let listingItem of filteredItems
                | mediaTypeFilter : type
                | paginate : {itemsPerPage: 30, currentPage: pageNo}
                | mediaListingCounter : counting
              "
            >
              <td class="name">
                <a href="#" (click)="detailItem=listingItem;false">
                  <i class="icon-medium" [class]="'icon-dashboard-media-' + listingItem.type"></i>
                  <strong>{{ listingItem.name }}</strong>
                </a>
              </td>
              <ng-container *ngIf="listingItem.metadata$ | async as metadata; else noMetadata">
                <td class="size">{{ metadata.size | filesize }}</td>
                <td class="type">{{ metadata.contentType }}</td>
                <td class="date">{{ metadata.updated | date }}</td>
              </ng-container>
              <ng-template #noMetadata>
                <td class="size">-</td>
                <td class="type">-</td>
                <td class="date">-</td>
              </ng-template>
            </tr>
          </tbody>

          <tfoot>
            <tr>
              <td colspan="42">
                <pagination-controls
                  (pageChange)="pageNo=$event"
                  [directionLinks]="false"
                ></pagination-controls>
              </td>
            </tr>
          </tfoot>

        </table>

        <div class="detail" [class.show]="detailItem" *ngIf="detailItem">
          <ng-container *ngIf="detailItem.metadata$ | async; let detailMetadata">
          <ng-container *ngIf="detailItem.downloadUrl$ | async; let downloadUrl">
            <div class="top">
              <div class="title">
                <i class="icon-medium" [class]="'icon-dashboard-type-' + detailItem.type"></i>
                <strong>{{ detailItem.name }}</strong>
              </div>
              <a href="#" (click)="detailItem=undefined;false">X</a>
            </div>
            <div class="content">
              <div class="view">
                <img *ngIf="detailItem.type==='image'" [src]="downloadUrl" [alt]="detailItem.name">
                <audio *ngIf="detailItem.type==='audio'" controls [src]="downloadUrl"></audio>
                <video *ngIf="detailItem.type==='video'" controls [src]="downloadUrl"></video>
              </div>
              <div class="name">
                <span>Name</span>
                <strong>
                  <a [href]="downloadUrl" target="_blank">{{ detailItem.name }}</a>
                </strong>
              </div>
              <div class="path"><span>Path</span><strong>{{ detailItem.fullPath }}</strong></div>
              <div class="size"><span>Size</span><strong>{{ detailMetadata.size | number }} bytes</strong></div>
              <div class="type"><span>Type</span><strong>{{ detailMetadata.contentType }}</strong></div>
              <div class="created"><span>Created</span><strong>{{ detailMetadata.timeCreated | date }}</strong></div>
              <div class="updated"><span>Updated</span><strong>{{ detailMetadata.updated | date }}</strong></div>
              <div class="actions">
                <button class="button-danger-sm" (click)="delete(detailItem)">Delete</button>
              </div>
            </div>
          </ng-container>
          </ng-container>
        </div>

      </div>
      
      <div class="footbar">
        <ng-container *ngTemplateOutlet="listingBar"></ng-container>
      </div>

    </div>

  </ng-container>
  </ng-container>
  </div>

  <ng-template #notFound>
    <div class="not-found">Not found ...</div>
  </ng-template>

</div>

<ng-template #loading>
  <div class="loading">Loading ...</div>
</ng-template>

<nguix-dashboard-uploader [show]="showUploader" (close)="showUploader=false"></nguix-dashboard-uploader>
